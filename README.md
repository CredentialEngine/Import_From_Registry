# Import_From_Registry
Sample project to import resources from the credential registry
# Purpose
Draft document to identify the steps and customization necessary to implement a local version of the credential registry import to a Sql server database. The primary focus is the import not the finder. We will include basic (initially) information on the configuring the finder, as the minimum to verify the import is working. 

# Requirements
- The code base is written in Microsoft C#.net. 
- The community edition of Visual Studio 2017+ is adequate to build and run the projects (import, finder, testing)
- IIS 7+ is needed to run the web project
- The project uses Sql Server as the data store. Backups are typically created using Sql server 2012, or 2016+
- The credential finder search uses Elastic. There is a separate search that uses native Sql server stored procedures. We have not been maintaining the sql search through code updates. However it should be good for prototyping.  
- Elastic documentation will follow soon. Once the end user installs elastic, the code to build and update the search indices is fairly straightforward.

## Code Base
The code base for the import and finder can be found in github:
https://github.com/CredentialEngine/Import_From_Registry

# Import
## Overview
<table>
  <tr><td width="65%" valign="top">
The main project for the import is in the solution Import folder, CTI.Import.Key project files:
    <ul><li>Program class is the startup, and calls separate classes for each type of import. </li>
      <li>RegistryImport includes the code to retrieve data from the registry - in the registry envelope container</li></ul>
The key app.config settings will be described below.     
<h3>Import.Services</h3>
<ul><li>NOTE: We are using the V3 import methods and the related MappingHelperV3 class. The original import methods have not been removed yet</li>
<li>Handles mapping from the JSON-LD format from the registry to POCO classes</li>
<li>After mapping the data successfully the appropriate related method from the workIT.Services project will be called to handle saving the data, marking data to be updated in elastic, and any caching methods. Example CredentialServices.Import( ThisEntity entity, ref SaveStatus status )</li></ul>
<h3>workIT.Services</h3>
<ul><li>Has all the business service layer code. There will be code used just by the import as well as by the credential finder</li>
<li>All data CRUD code is in the workIt.Factories project</li>
<li>We mostly use entity frameworks (database first) for interfacing with the database. workIT.Data contains the related edmx files. We used separate edmx files for tables and views. </li>
<li>There are a few stored procedures in use, mostly for retrieving data to load into the elastic indices
  <li>Most DTO classes are in the workIT.Models project</li></ul></td><td>

![image](https://user-images.githubusercontent.com/26332112/54700479-1a4fd200-4b01-11e9-8092-30b2d68f14dd.png)
      </td>
</tr>
</table>




<table class="c24"><tbody><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">GeoNamesUserName</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Provide your custom user name for google geo services</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">scheduleType</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">&nbsp;Options:</span></p><ul class="c4 lst-kix_14f7h5cunlxz-0 start"><li class="c1 c3"><span class="c2">daily, </span></li><li class="c1 c3"><span class="c2">sinceLastRun, </span></li><li class="c1 c3"><span class="c2">hourly, </span></li><li class="c1 c3"><span class="c2">adhoc, </span></li><li class="c1 c3"><span class="c2">or integer - meaning minutes. Could use to schedule for 7:00 am and minutes since 8pm previous night</span></li></ul><ul class="c4 lst-kix_14f7h5cunlxz-1 start"><li class="c1 c12"><span class="c2">will need to record or derive the last run </span></li></ul></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">DoingDownloadOnly</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Normally false, set to true if say only want to download and save the registry document and not import data</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">startingDate</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">If doing an adhoc run, provide the starting date. </span></p><p class="c1"><span class="c2">NOTE: start/end dates will be converted to UTC before calling the registry searches. If the dates will be provided in UTC, be sure to set usingUTC_ForTime to false.</span></p><p class="c1 c10"><span class="c2"></span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">endingDate</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">If doing an adhoc import and the endDate is to be less than the current date, then provide an end date.</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">usingUTC_ForTime</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">If true (default), the import will convert any calculated dates to UTC. </span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">Import Entity options.</span></p><p class="c1"><span class="c23">Importing_credential</span></p><p class="c1"><span class="c23">Importing_assessment_profile</span></p><p class="c1"><span class="c23">Importing_learning_opportunity_profile</span></p><p class="c1"><span class="c23">importing_organization</span></p><p class="c1"><span class="c23">Importing_cost_manifest_schema</span></p><p class="c1"><span class="c23">importing_condition_manifest_schema</span></p><p class="c1"><span class="c23">importing_competency_frameworks</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Normally these are all true. Set to false if wish to only import particular entities. </span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">Skipping options - normally false</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">special codes for imports to handle special cases. Typically due to a change to data format in the registry</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">deleteAction</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Actions: 0-normal; 1-DeleteOnly; 2-SkipDelete </span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1 c10"><span class="c2"></span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1 c10"><span class="c2"></span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">doingExpandOfRegion</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">If true expand state abbreviations to the full name</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">Keys that are needed due to common code used by the finder, but not applicable directly to the import</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">ed by the finder, but not applicable directly to the import--&gt;</span></p><p class="c1"><span class="c2">&nbsp; &nbsp; &lt;add key=&quot;credentialCacheMinutes&quot; value=&quot;1&quot; /&gt;</span></p><p class="c1"><span class="c2">&nbsp; &nbsp; &lt;add key=&quot;organizationCacheMinutes&quot; value=&quot;1&quot; /&gt;</span></p><p class="c1"><span class="c2">&nbsp; &nbsp; &lt;add key=&quot;learningOppCacheMinutes&quot; value=&quot;1&quot; /&gt;</span></p><p class="c1"><span class="c2">&nbsp; &nbsp; &lt;add key=&quot;maxKeywordLength&quot; value=&quot;200&quot; /&gt;</span></p><p class="c1"><span class="c2">&nbsp; &nbsp; &lt;add key=&quot;maxReferenceTextLength&quot; value=&quot;900&quot; /&gt;</span></p><p class="c1"><span class="c2">&nbsp; &nbsp; &lt;add key=&quot;maxReferenceUrlLength&quot; value=&quot;600&quot; /&gt;</span></p><p class="c1 c10"><span class="c2"></span></p></td></tr><tr class="c9"><td class="c8 c31" colspan="1" rowspan="1"><p class="c1"><span class="c2">&nbsp;CR registry</span></p></td><td class="c13 c31" colspan="1" rowspan="1"><p class="c1"><span class="c2">Keys related to the target credential registry environment</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">usingGraphDocuments</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Always true now. </span></p></td></tr><tr class="c9"><td class="c8 c15" colspan="1" rowspan="1"><p class="c1"><span class="c2">sandbox</span></p></td><td class="c13 c15" colspan="1" rowspan="1"><p class="c1"><span class="c2">If downloading from the sandbox: </span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1 c10"><span class="c2"></span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">&nbsp; &nbsp; &lt;add key=&quot;credentialRegistryUrl&quot; value=&quot;https://sandbox.credentialengineregistry.org&quot; /&gt;</span></p><p class="c1"><span class="c2">&nbsp; &nbsp; &lt;add key=&quot;credentialRegistryGet&quot; value=&quot;https://sandbox.credentialengineregistry.org/ce-registry/envelopes/{0}&quot; /&gt;</span></p><p class="c1"><span class="c2">&nbsp; &nbsp; &lt;add key=&quot;credentialRegistrySearch&quot; value=&quot;https://sandbox.credentialengineregistry.org/ce-registry/search?&quot; /&gt;</span></p><p class="c1"><span class="c2">&nbsp; &nbsp; &lt;add key=&quot;credentialRegistryResource&quot; value=&quot;https://sandbox.credentialengineregistry.org/graph/{0}&quot; /&gt;</span></p><p class="c1 c10"><span class="c2"></span></p></td></tr><tr class="c9"><td class="c8 c40" colspan="1" rowspan="1"><p class="c1"><span class="c2">production</span></p></td><td class="c13 c40" colspan="1" rowspan="1"><p class="c1"><span class="c2">If downloading from production:</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1 c10"><span class="c2"></span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">&lt;add key=&quot;credentialRegistryUrl&quot; value=&quot;https://credentialengineregistry.org&quot; /&gt;</span></p><p class="c1"><span class="c2">&lt;add key=&quot;credentialRegistryGet&quot; value=&quot;https://credentialengineregistry.org/ce-registry/envelopes/{0}&quot; /&gt;</span></p><p class="c1"><span class="c2">&lt;add key=&quot;credentialRegistrySearch&quot; value=&quot;https://credentialengineregistry.org/ce-registry/search?&quot; /&gt;</span></p><p class="c1"><span class="c2">&lt;add key=&quot;credentialRegistryResource&quot; value=&quot;https://credentialengineregistry.org/resources/{0}&quot; /&gt; </span></p><p class="c1 c10"><span class="c2"></span></p></td></tr><tr class="c9"><td class="c8 c16" colspan="1" rowspan="1"><p class="c1"><span class="c2">Elastic search related</span></p></td><td class="c13 c16" colspan="1" rowspan="1"><p class="c1 c10"><span class="c2"></span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">elasticSearchUrl</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Url to the instance of elastic being used</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">credentialRebuildPageSize</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Was used in prototyping, typically set to a large size like 9999. The import typically imports a small amount daily, or hourly. More pertinent for a full rebuild. </span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">credentialCollection</span></p><p class="c1"><span class="c2">organizationCollection assessmentCollection</span></p><p class="c1"><span class="c2">learningOppCollection</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Name of elastic collection that will be updated by the import. Can use different collections for different sources. For example one for a test environment and another for production copies.</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">Options to use or not use Elastic for the searches </span></p><p class="c1"><span class="c2">usingElasticCredentialSearch</span></p><p class="c1"><span class="c2">usingElasticOrganizationSearch</span></p><p class="c1"><span class="c2">usingElasticAssessmentSearch</span></p><p class="c1"><span class="c2">usingElasticLearningOppSearch</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">These are always true, unless using sql server for searching. </span></p><p class="c1"><span class="c2">Note that the sql search has been set as the default, so these keys will all be set to false.</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">delayingAllCacheUpdates</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">False - will update caches, and elastic on a per record basis, </span></p><p class="c1"><span class="c2">True - store requests in the SearchPendingReindex table, and handle at end of import.</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">updateCredIndexAction</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Action to take when updating an elastic index. </span></p><p class="c1"><span class="c2">0-none; 1- Use Index; 2-use Bulk (default)</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1 c10"><span class="c2"></span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1 c10"><span class="c2"></span></p></td></tr><tr class="c9"><td class="c8 c34" colspan="1" rowspan="1"><p class="c1"><span class="c2">Section for email </span></p></td><td class="c13 c34" colspan="1" rowspan="1"><p class="c1"><span class="c2">The user would update this section for providers for sending emails. There is an email manager with code to Mailgun, an api service and localhost (not recently verified). The email service is disabled by default.</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1 c10"><span class="c2"></span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">&nbsp;&lt;add key=&quot;sendEmailFlag&quot; value=&quot;FALSE&quot; /&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td></tr><tr class="c9"><td class="c8 c37" colspan="1" rowspan="1"><p class="c1"><span class="c2">Section for tracing and logging</span></p></td><td class="c13 c37" colspan="1" rowspan="1"><p class="c1"><span class="c2">The utilities project has code for tracing, logging errors, and saving files (example files downloaded from registry). The same approach is used in the finder project. </span></p><p class="c1"><span>The default folder for logs is c:\@logs. Create the latter folder and give modify access as needed for your environment, or just select </span><span class="c22">Everyone</span><span class="c2">.</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">appTraceLevel</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Set to the max level of tracing to display. The DoTrace methods start with a display level. The actual method that outputs trace messages to a file (and console) will only output message with a display level less than or equal to the value of appTraceLevel. </span></p><p class="c1"><span class="c2">LoggingHelper.DoTrace( 8,&rdquo;some message to only show in rare circumstances&rdquo; );</span></p><p class="c1"><span class="c2">Or to messages to always log. </span></p><p class="c1"><span class="c2">LoggingHelper.DoTrace( 1, string.Format( &quot; - Updates since: {0} &quot;, startingDate ) );</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">path.error.log</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span>Path and filename for file to store error messages. </span><span class="c36">Uses a pattern so only a month of files are kept, and then overwritten</span><span class="c2">. </span></p><p class="c1"><span class="c20">C:\@logs\[date]_FinderImport_ErrorLog.txt</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">path.trace.log</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Path and filename for file to store trace messages. Uses a pattern so only a month of files are kept, and then overwritten. </span></p><p class="c1"><span class="c20">C:\@logs\[date]_FinderImport_TraceLog.txt</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">path.log.file</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Path and pattern for saving files such as registry downloads. </span></p><p class="c1"><span class="c20">C:\@logs\RegistryDownload\[date]_[filename].json</span></p><p class="c1"><span class="c2">If using the latter default value, be sure to create the RegistryDownload folder in the C:\@logs folder.</span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">path.email.log</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">Path to file for logging emails, if logAllEmail=yes</span></p></td></tr><tr class="c9"><td class="c8 c11" colspan="1" rowspan="1"><p class="c1"><span class="c2">Connection strings</span></p></td><td class="c13 c11" colspan="1" rowspan="1"><p class="c1 c10"><span class="c2"></span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">DefaultConnection</span></p><p class="c1"><span class="c2">AccountEntities</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">These are not enabled for this project - yet. Authentication is not used by the import. The finder uses SSO via the accounts site. </span></p></td></tr><tr class="c9"><td class="c8" colspan="1" rowspan="1"><p class="c1"><span class="c2">MainConnection</span></p><p class="c1"><span class="c2">workIT_RO</span></p><p class="c1"><span class="c2">workITEntities</span></p><p class="c1"><span class="c2">workITViews</span></p></td><td class="c13" colspan="1" rowspan="1"><p class="c1"><span class="c2">These are set up for sql server. User should only have to provide the database name (if not using the default), server name/data source, and password. </span></p></td></tr></tbody></table>
